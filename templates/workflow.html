{% extends 'base.html' %}

{% block title %}工作流 - 服务器管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/workflow.css') }}">
{% endblock %}

{% block header_content %}
<div>
    <h1>工作流编辑器 <span id="current-workflow-name" style="font-size: 14px; color: #666; font-weight: normal; margin-left: 10px; display: none;"></span></h1>
</div>
<div class="top-actions">
    <div class="zoom-controls">
        <button id="zoom-out" class="btn btn-secondary" title="缩小">-</button>
        <span id="zoom-level">100%</span>
        <button id="zoom-in" class="btn btn-secondary" title="放大">+</button>
        <button id="zoom-reset" class="btn btn-secondary" title="重置">重置</button>
    </div>
    <div class="divider"></div>
    <div class="action-group">
        <button id="load-workflow-btn" class="btn btn-secondary">📂 加载</button>
        <button id="save-workflow-btn" class="btn btn-secondary">💾 保存</button>
        <button id="save-as-workflow-btn" class="btn btn-secondary">📑 另存为</button>
        <button id="global-vars-btn" class="btn btn-secondary">🌐 全局变量</button>
    </div>
    <div class="divider"></div>
    <button id="clear-btn" class="btn btn-secondary">清空画布</button>
    <button id="run-btn" class="btn btn-primary">运行工作流</button>
</div>
{% endblock %}

{% block content %}
<div class="content workflow-content">
    <div class="workflow-container">
        <div class="workspace">
            <div id="canvas" class="canvas">
                <div id="canvas-content" class="canvas-content">
                    <svg id="connections" class="connections-layer"></svg>
                </div>
                <aside class="component-panel draggable-panel">
                    <div class="panel-header">
                        <h3>组件库</h3>
                        <div class="drag-handle">✥</div>
                    </div>
                    <div class="component-section">
                        <h4>服务器</h4>
                        <div id="server-list" class="draggable-items"></div>
                    </div>
                    <div class="component-section">
                        <h4>事件</h4>
                        <div class="draggable-items">
                            <div class="draggable-item" draggable="true" data-type="upload">
                                <span class="icon">⬆️</span>
                                <span>上传文件</span>
                            </div>
                            <div class="draggable-item" draggable="true" data-type="command">
                                <span class="icon">⚡</span>
                                <span>执行命令</span>
                            </div>
                
                        </div>
                    </div>
                </aside>
            </div>
            <div class="splitter" id="workspace-splitter"></div>
            <aside class="result-panel">
                <h3>执行结果</h3>
                <div id="output-container">
                    <!-- 动态生成内容 -->
                </div>
            </aside>
        </div>
    </div>
</div>

<!-- 保存工作流弹窗 -->
<div id="save-workflow-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>保存工作流</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <label for="workflow-name">名称</label>
            <input type="text" id="workflow-name" class="form-input" placeholder="请输入工作流名称">
            <label for="workflow-desc">描述</label>
            <input type="text" id="workflow-desc" class="form-input" placeholder="可选描述">
        </div>
        <div class="modal-footer">
            <button id="cancel-save-wf" class="btn btn-secondary">取消</button>
            <button id="confirm-save-wf" class="btn btn-primary">保存</button>
        </div>
    </div>
</div>

<!-- 加载工作流弹窗 -->
<div id="load-workflow-modal" class="modal">
    <div class="modal-content" style="width: 600px;">
        <div class="modal-header">
            <h3>加载工作流</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div id="workflow-list" class="workflow-list">
                <!-- 动态生成列表 -->
                <div class="loading-spinner"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancel-load-wf" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>

<div id="command-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>编辑命令</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <label for="command-input">命令</label>
            <input type="text" id="command-input" class="form-input" placeholder="例如: ls -la">
            <label for="command-ref-name">引用名称 (变量名)</label>
            <input type="text" id="command-ref-name" class="form-input" placeholder="例如: step1 (后续可用 {{ '{{' }}step1.output{{ '}}' }})">
            <label for="command-description">描述</label>
            <input type="text" id="command-description" class="form-input" placeholder="描述">
        </div>
        <div class="modal-footer">
            <button id="cancel-command" class="btn btn-secondary">取消</button>
            <button id="save-command" class="btn btn-primary">保存</button>
        </div>
    </div>
</div>
<div id="upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>上传文件</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <label for="upload-file">选择文件</label>
            <div id="current-file-info" style="margin-bottom: 10px; font-size: 12px; color: #666;"></div>
            <input type="file" id="upload-file" class="form-input">
            <label for="remote-path">远程路径</label>
            <input type="text" id="remote-path" class="form-input" placeholder="/tmp/upload.bin">
            <label for="upload-ref-name">引用名称 (变量名)</label>
            <input type="text" id="upload-ref-name" class="form-input" placeholder="例如: upload1">
        </div>
        <div class="modal-footer">
            <button id="cancel-upload" class="btn btn-secondary">取消</button>
            <button id="save-upload" class="btn btn-primary">保存</button>
        </div>
    </div>
</div>

<div id="connection-popover" class="connection-popover" style="display: none;">
    <div class="popover-content">
        <div class="popover-row">
            <label>类型:</label>
            <select id="conn-type-select">
                <option value="default">默认 (Always)</option>
                <option value="success">成功时 (Success)</option>
                <option value="failure">失败时 (Failure)</option>
            </select>
        </div>
        <div class="popover-actions">
            <button id="delete-conn-btn" class="btn btn-sm btn-danger">删除连线</button>
        </div>
    </div>
</div>

<div id="alignment-popover" class="floating-toolbar" style="display: none;">
    <div class="toolbar-group">
        <button id="align-left" title="左对齐">⇤</button>
        <button id="align-center-h" title="水平居中">⇹</button>
        <button id="align-right" title="右对齐">⇥</button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
        <button id="align-top" title="顶部对齐">⤒</button>
        <button id="align-center-v" title="垂直居中">⇕</button>
        <button id="align-bottom" title="底部对齐">⤓</button>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
        <button id="dist-h" title="水平等间距">H=</button>
        <button id="dist-v" title="垂直等间距">V=</button>
    </div>
</div>

<!-- 全局变量弹窗 -->
<div id="global-vars-modal" class="modal">
    <div class="modal-content" style="width: 700px;">
        <div class="modal-header">
            <h3>全局变量管理</h3>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <div class="global-vars-container">
                <div class="new-var-form">
                    <input type="text" id="new-var-key" class="form-input" placeholder="变量名 (如: deploy_path)" style="width: 30%;">
                    <input type="text" id="new-var-value" class="form-input" placeholder="变量值" style="width: 40%;">
                    <input type="text" id="new-var-desc" class="form-input" placeholder="描述" style="width: 20%;">
                    <button id="add-global-var-btn" class="btn btn-primary" style="width: 8%;">+</button>
                </div>
                <div class="vars-list-header">
                    <span style="width: 30%;">变量名</span>
                    <span style="width: 40%;">值</span>
                    <span style="width: 20%;">描述</span>
                    <span style="width: 10%;">操作</span>
                </div>
                <div id="global-vars-list" class="vars-list">
                    <!-- 动态生成 -->
                </div>
            </div>
            <div class="help-text" style="margin-top: 10px; color: #666; font-size: 12px;">
                💡 使用方式: 在命令或路径中使用 {{ '{{' }}global.变量名{{ '}}' }} 引用
            </div>
        </div>
        <div class="modal-footer">
            <button id="close-global-vars" class="btn btn-secondary">关闭</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/workflow.js') }}"></script>
{% endblock %}
